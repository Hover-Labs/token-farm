# Token farm

⚠️ Architecture diagram can be found [here](https://viewer.diagrams.net/?highlight=0000ff&edit=_blank&layers=1&nav=1&title=staker%20farm#R7Vxtc5s4EP41nul9iAckXj8madJ2LnftXHJzTb8pRrZpMfJgHMf99ScZCRDCNgkC42nd6QSEBPLus7vPLpJH8Hrx8iFBy%2FlfJMDRCBjBywi%2BHwFg%2Bp5L%2F7CWbdbiukbWMEvCgHcqGu7Dn5g3im7rMMArqWNKSJSGS7lxQuIYT1KpDSUJ2cjdpiSSn7pEM6w03E9QpLb%2BFwbpPGv1gFu0f8ThbC6ebDp%2BdmWBRGf%2BTVZzFJBNqQnejOB1QkiaHS1ernHEhCfkko273XM1n1iC47TJAPAp%2BHfrTD%2FCz3f38%2FQBffvoxxc24JNLt%2BIb44AKgJ%2BSJJ2TGYlRdFO0XiVkHQeY3dakZ0WfO0KWvPE7TtMt1yZap4Q2zdNFxK%2FiOLhkuqGnkwitVuEka7wNo6JLmmy%2Flk8e6YkxNjwgGt4zkBn52bZ89gUn4QKnOOGNqrC4%2FFZknUzwAQkBLqEUJTOcHugIueKZ%2FEqP4Mr4gAmdT7KlHRIcoTR8lgGGOE5neb986BcS0kkDg9uUBzmguEWZwDLke2RT5cMKRNCD0jyKph1OXoEZ8zSQ4XgwZDzYx9DwEqZfi5707FHckR4Xg9jJtjVYTL8pWMx%2BwAIEKnOw2M3AQu0TbUvdlqzDav%2BDfEt%2BjmFXvFF1YpbfdoApDaAH2Zy1Yt2CQwK72xTtZgnrBfJ1o12A%2BCjarU7A%2FlqIOlXHWUHQ0QGub3ePOB5unlG05nJQEFjgi%2BlvMw9TfL9EO1VtKAuTsTSlMfWaRIRFwpjEDJ8BWs1zeK7ShPzIuQ04BIhnnKT45aAGhbG6piQ5z%2BOS3BQcynS5Qc9L%2FAkY9n6tS4HstXKFilxvL80xbXIi%2Buyrp4QezdjR3Zcdx%2FyBY32CHwEYIOxNJ7nAS1eciYefpnoED20ZsUaN3AW1LsvdrHIIbXK3auROz2tFf%2F%2Fw5z9q67sZeRYq%2BUOvTmzsBVadTjzwBB1Hj04c15GU4vgnV4pz0qhWofTHgloLOgYGEXgsR6Yuvns47lT7u%2B4BpqOMNi27dnRf6YGrGDygVkvnYKcJildTnLxbr2hixiyaKRFHU9Wqmcbu0BOOZAihKJzF9HhCocByuytmhSHN1i%2F5hUUYBBla8Sr8iZ5292Mg4jqiN7evRvb7WlgdMhXF3POSA3%2FIqJzV17kBCnS%2FwsZFUHoryRddyHS6wt3kekatanrjv2PT82Vv4ftO45QPlHO%2BnPjWsuBTVQ20U%2BNWccEUwa0w3oVwE8M0TwHQ9vZ5QfMrx5J5K2hnny%2FSXYTRAzCmjqD08eQbdmjNanIR4CVZhaqG29Cq6XQKJrVUN3CeHFsTrQJeJaraNbTKAiqt6oxVme2KBUa%2FlbEWtKpplUs%2F%2F2qnHzUX2VGT3AYMFAc7%2FaEfeMg%2BT%2BSyOnyeCQxXp8%2FrwYvZpzWzwrIey9c6M7Oua8S%2BXOXy%2Bn6dIBh2YZUmTxjQcpmQ50Gboq3TFA3HHbzxua2M7%2Ffbn1124A4rLnqKBUJmgZMIhYs8Kq7jwcdFUXrQYYzAdLTGxbwyPrbrbtuD5fqKlrM6jE7mb7N%2FtUXu3YeNIHFaas8%2BmorfDRKCujprZwkB9E7qLHurszaudkDtju9tBVlXpjw%2BPFKQPdy%2Fo1fP7Whu%2B9Kb%2Byqe22RNTx6NHd8rxWPqbQ0LHi7P0ZNfvjpnqUx5HS8R9eIDDsqWToYMPFMu0InFSMMlzPZpK%2Bjm2DC9SgWd0s83LKFrYOA9WKT2itKbAogLZRjmmVunEcFWq%2FMRWseTOaZTNaaUUlHBoMmc3SdmJh4%2BU3ww7s7WNAzWQ9g6S%2FiW58gr0fTQ9r1Fe%2F4USC9b8k27cyniO5VwMKEOYxKykYt1lIZM1eFM0fnw1684ToVpmacu6oOT0LAWnnQYFBtWFGmaRzj2ReXV26sHuEcWkFaXRtkHOHzTwX3VSIHK%2FGB1UQVbSDHiiypYYj%2FkRRVAJym0HKNCClv6%2FB48uLpIZhOm8yBBG3q%2FfZW283snaxrw5P7bP4X%2FfnPBuiDZhIJjbwpdWeBtHy5pa86eRydKnutds21XVss5zXzzayOaDSrlRR8ejDfV%2FmJezQKOZVfip1isns8301NnIUcYbslFIRZyRLwZcnQRlW4d0QW6hpxQtC05CHjAcWXPjD92elsJZKlLIeZotUscwzREbPwTihDNIukRYbwiW5v9C%2BicEgrfl%2BleW0IhSKQ3tqpMZVzd8NCdzqFaPuBv%2BM6eZ%2Fh1S%2Bp7pRlQzckDHFGsJDvcnZ%2BIL6q7pWBdKi42N5dlDDuTsbqHZ0YlfI77dFTpWieXrhoSUICWqXb89rPrRpEwqNuD1q%2BEbUXCWVQ1bi%2BvHz7%2F80iP7j79fbNL7PkuKLEJavP14dsF%2FS8u0Ank1xTtUBGlsgpkUfN9gM3DdJ2CZQhIewpVh0U%2FetQKDbuygMJza%2FRa95ofdKZXNZtHwff1Kt1Rhg1Kgt233pL1ma6zrkj89EVZsdLjvHfJWpWXCKZZFwRcrwbKVlfbZC017Wvso1jH3z6KZf5uRa91VbBeXZSlLvFTNDKMH37ZK%2F%2BjdSmLS%2F3cVnWovmzwazoEmnQUWAzD1%2FrGtofiiRrvucaM2ZpG%2BxCdY0pSffXqnDzK22q%2BF%2BEZZquR3xZMaqK8zviiQwly4KChRHCvkhYsPZGDnha%2FPpbZRvEbbvDmfw%3D%3D)

## Storage

```
type delegator = address
type delegatorRecord = {
    balance: nat,
    rewardDebt: nat,
};

type claimedRewards = {
    unpaid: nat,
    paid: nat,
};

type plannedRewards = {
    totalBlocks: nat,
    rewardPerBlock: nat,
};

type storage = {
    lastBlockUpdate: nat,
    accumulatedSTKRPerShare: nat,
    claimedRewards: claimedRewards,
    plannedRewards: plannedRewards,
    delegators: big_map(delegator, delegatorRecord),
    lpTokenContract: address,
    farmTokenBalance: nat,
    rewardTokenContract: address,
};
```

- #### `claimedRewards: claimedRewards`

    Keeps track of pool rewards that have been paid or are pending to be paid out

    - `unpaid` 
    - `paid`

- #### `plannedRewards: plannedRewards`

    Configuration object set at origination, specifying how much of the reward token
    should be paid out every block. And how many blocks of lifetime the farm has.

    The overall amount of the reward token distributed is calculated as `totalBlocks * rewardPerBlock`.

    - `totalBlocks`
    - `rewardPerBlock`

- #### `delegators: big_map(delegator, delegatorRecord)`

    (big) Map of delegator addresses and their staking balances & reward debts.


    ##### - `key: delegator (address)`
    ##### - `value: delegatorRecord`
    - `balance`
        
        Represents the total staked balance (of the staking token) of the current delegator

    - `rewardDebt`

        Represents when was the last payout made to the given delegator, or when he joined the staking pool.

        ##### Example
        If `rewardPerBlock = 100 RewardToken` and the delegator joins the staking pool at block height 5,
        relative to when the farm was started, then `rewardDebt = 5 * rewardPerBlock = 500 RewardToken`


- #### `lastBlockUpdate: nat`

    Keeps track of the last time the pool state was updated. This is used to prevent
    duplicate pool state updates in the same block. Invariant of the system achieved thanks to the
    `lastBlockUpdate` is that the delegation rewards start accumulating only in the `n+1` block after depositing.

    E.g. if you deposit in `block 0`, you're only eligible for rewards from `block 1`

- #### `accumulatedSTKRPerShare: nat`

    Keeps track of how many reward token each liquidity pool share (staked LP token) is worth. This number is recalculated at every pool update.

- #### `lpTokenContract: address`
    Address of the token being staked, originally an LP token from a DEX.

- #### `farmTokenBalance: nat`
    Balance of the `lpTokenContract` tokens for the current farm contract. This standalone "ledger" entry exists to
    avoid exploits with operations that may introduce issues & overhead due to Tezos' message passing architecture ([BFS](https://forum.tezosagora.org/t/smart-contract-vulnerabilities-due-to-tezos-message-passing-architecture/2045)), specifically when calling `tokenContract%getBalance`.

- #### `rewardTokenContract: address`

    Address of the reward token contract.



## Entrypoints

#### `%deposit(nat)`

This entrypoint serves as an gateway to the farm. Users can deposit a certain amount of stakeable LP tokens to begin
accumulating staking rewards, which can be claimed at a later point in time through manual interaction with the contract.

##### Parameters

- `nat`

    A single value representing the amount of stakeable tokens being deposited. The user depositing
    must create an appropriate allowance by calling `%approve` on the underlying token contract beforehand. The farm itself will
    transfer the specified amount to its own KT1 address.

    This mechanism is important to maintain the `farmTokenBalance` in the storage.


#### `%claim()`

This entrypoint calculates the earned reward tokens for the user invoking it and pays it out.

##### Parameters

- `unit`

#### `withdraw(nat)`

This entrypoint unstakes the number of LP tokens the delegator specifies and pays out earned reward tokens.
##### Parameters

- `nat`
    Number of staked LP tokens the user wants to withdraw.


## Farm pool & state updates

Each farm instance has its own pool, that keeps track of vital data such as `accumulatedSTKRPerShare`. Each
pool can be updated only once per block - this is ensured by keeping track of `lastBlockUpdate`.

Entrypoints `%deposit`, `%claim`, `%withdraw` all call an `updatePool()` function either directly or indirectly, causing the
pool to update with every first operation that 'arrives' to the farm in each block.

If there are no tokens delegated to the farm, which means if `farmTokenBalance = 0n` then pool updates are skipped. Resulting
in no rewards being distributed, and only the `lastBlockUpdate` being increased. If this behavior was not part of the implementation then rewards would be lost for blocks when no-one is delegating to the farm.

#### Pool update formulas

##### - `reward`

If the calculated reward from the formula below exceeds the `plannedRewards`, then a `rewardRemainder` is returned instead.
> Calculation of `plannedRewards` and `rewardRemainder` can be found in `updatePool.religo`

`(Tezos.level - lastBlockUpdate) * rewardPerBlock`

##### - `accumulatedSTKRPerShare`

`accumulatedSTKRPerShare + reward / farmTokenBalance`


##### Reward calculation per delegator

`accumulatedSTKRPerShare * delegatorBalance - delegatorRewardDebt`